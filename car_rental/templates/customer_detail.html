{% extends 'base.html' %}
{% load static %}

{% block title %}Customer Details - {{ customer.name }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-4">
            <!-- Customer Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header {% if customer.is_banned %}bg-danger{% else %}bg-dark{% endif %} text-white text-center">
                    <h5 class="mb-0">
                        Customer Information
                        {% if customer.is_banned %}
                            <span class="badge bg-warning text-dark">BANNED</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        {% if customer.user.profile.profile_picture %}
                            <img src="{{ customer.user.profile.profile_picture.url }}" alt="Profile Picture" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
                        {% else %}
                            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mx-auto" style="width: 100px; height: 100px;">
                                <i class="fas fa-user fa-2x text-white"></i>
                            </div>
                        {% endif %}
                    </div>
                    <h5 class="text-center">{{ customer.name }}</h5>
                    <p class="text-center text-muted">{{ customer.email }}</p>
                    
                    <hr>
                    
                    <div class="mb-2">
                        <strong>Phone:</strong> {{ customer.phone|default:"Not provided" }}
                    </div>
                    <div class="mb-2">
                        <strong>Address:</strong> {{ customer.address|default:"Not provided" }}
                    </div>
                    <div class="mb-2">
                        <strong>Driver's License:</strong> 
                        {% if customer.drivers_license %}
                            {{ customer.drivers_license }}
                            {% if customer.has_valid_license %}
                                <span class="badge bg-success ms-2">Valid</span>
                            {% else %}
                                <span class="badge bg-warning ms-2">Expired</span>
                            {% endif %}
                        {% else %}
                            Not provided
                        {% endif %}
                    </div>
                    <div class="mb-2">
                        <strong>License Expiry:</strong> {{ customer.license_expiry|date:"F d, Y"|default:"Not provided" }}
                    </div>
                    <div class="mb-2">
                        <strong>Status:</strong> 
                        {% if customer.is_banned %}
                            <span class="badge bg-danger">Banned</span>
                        {% else %}
                            <span class="badge bg-success">Active</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-grid gap-2">
                        <a href="{% url 'car_rental:my_rentals' %}" class="btn btn-outline-primary">
                            <i class="fas fa-car me-2"></i> My Rentals
                        </a>
                        <a href="{% url 'car_rental:my_purchases' %}" class="btn btn-outline-primary">
                            <i class="fas fa-shopping-cart me-2"></i> My Purchases
                        </a>
                        <!-- REMOVED THE UPDATE CUSTOMER BUTTON -->
                    </div>
                </div>
            </div>
            
            <!-- Statistics Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Customer Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="stat-number">{{ customer.rentals.count }}</div>
                            <div class="stat-label">Total Rentals</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stat-number">{{ customer.purchases.count }}</div>
                            <div class="stat-label">Total Purchases</div>
                        </div>
                        <div class="col-12">
                            <div class="stat-number">₦{{ customer.get_total_spent|floatformat:2 }}</div>
                            <div class="stat-label">Total Spent</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin Actions Card -->
            {% if request.user.is_staff %}
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Admin Actions</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'car_rental:customer_ban_delete' customer.id %}">
                            {% csrf_token %}
                            <div class="d-grid gap-2">
                                {% if customer.is_banned %}
                                    <button type="submit" name="action" value="unban" class="btn btn-success">
                                        <i class="fas fa-user-check me-2"></i> Unban Customer
                                    </button>
                                {% else %}
                                    <button type="submit" name="action" value="ban" class="btn btn-warning">
                                        <i class="fas fa-user-slash me-2"></i> Ban Customer
                                    </button>
                                {% endif %}
                                
                                <button type="submit" name="action" value="delete" class="btn btn-danger" 
                                        onclick="return confirm('Are you sure you want to delete this customer? This action cannot be undone.')">
                                    <i class="fas fa-trash me-2"></i> Delete Customer
                                </button>
                                
                                <button type="submit" name="action" value="ban_and_delete" class="btn btn-danger" 
                                        onclick="return confirm('Are you sure you want to ban and delete this customer? This action cannot be undone.')">
                                    <i class="fas fa-user-slash me-2"></i> Ban and Delete Customer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            {% endif %}
        </div>
        
        <div class="col-lg-8">
            <!-- Tabs for Customer Information -->
            <ul class="nav nav-tabs" id="customerTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="rentals-tab" data-bs-toggle="tab" data-bs-target="#rentals" type="button" role="tab">Rental History</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="purchases-tab" data-bs-toggle="tab" data-bs-target="#purchases" type="button" role="tab">Purchase History</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services" type="button" role="tab">Service History</button>
                </li>
            </ul>
            
            <div class="tab-content mt-3" id="customerTabsContent">
                <!-- Rentals Tab -->
                <div class="tab-pane fade show active" id="rentals" role="tabpanel">
                    {% if customer.rentals.all %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Car</th>
                                        <th>Rental Date</th>
                                        <th>Return Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rental in customer.rentals.all %}
                                        <tr>
                                            <td>{{ rental.car.make }} {{ rental.car.model }}</td>
                                            <td>{{ rental.rental_datetime|date:"M d, Y" }}</td>
                                            <td>{{ rental.return_datetime|date:"M d, Y" }}</td>
                                            <td>₦{{ rental.total_amount|floatformat:2 }}</td>
                                            <td>
                                                <span class="badge {% if rental.status == 'completed' %}bg-success{% elif rental.status == 'active' %}bg-primary{% elif rental.status == 'overdue' %}bg-danger{% else %}bg-warning{% endif %}">
                                                    {{ rental.get_status_display }}
                                                </span>
                                            </td>
                                            <td>
                                                <a href="{% url 'car_rental:rental_detail' rental.id %}" class="btn btn-sm btn-outline-primary">View</a>
                                                {% if rental.status == 'active' %}
                                                    <a href="{% url 'car_rental:return_rental' rental.id %}" class="btn btn-sm btn-outline-success">Return</a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No rental history found for this customer.
                        </div>
                    {% endif %}
                </div>
                
                <!-- Purchases Tab -->
                <div class="tab-pane fade" id="purchases" role="tabpanel">
                    {% if customer.purchases.all %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Car</th>
                                        <th>Purchase Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for purchase in customer.purchases.all %}
                                        <tr>
                                            <td>{{ purchase.car.make }} {{ purchase.car.model }}</td>
                                            <td>{{ purchase.purchase_datetime|date:"M d, Y" }}</td>
                                            <td>₦{{ purchase.total_amount|floatformat:2 }}</td>
                                            <td>
                                                <span class="badge {% if purchase.status == 'delivered' %}bg-success{% elif purchase.status == 'processing' %}bg-primary{% elif purchase.status == 'cancelled' %}bg-danger{% else %}bg-warning{% endif %}">
                                                    {{ purchase.get_status_display }}
                                                </span>
                                            </td>
                                            <td>
                                                <a href="{% url 'car_rental:purchase_detail' purchase.id %}" class="btn btn-sm btn-outline-primary">View</a>
                                                <a href="{% url 'car_rental:update_purchase_status' purchase.id %}" class="btn btn-sm btn-outline-warning">Update Status</a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No purchase history found for this customer.
                        </div>
                    {% endif %}
                </div>
                
                <!-- Services Tab -->
                <div class="tab-pane fade" id="services" role="tabpanel">
                    {% if customer.service_bookings.all %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Service Type</th>
                                        <th>Preferred Date</th>
                                        <th>Car</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for service in customer.service_bookings.all %}
                                        <tr>
                                            <td>{{ service.get_service_type_display }}</td>
                                            <td>{{ service.preferred_date|date:"M d, Y" }}</td>
                                            <td>{{ service.car_year }} {{ service.car_make }} {{ service.car_model }}</td>
                                            <td>
                                                <span class="badge {% if service.status == 'completed' %}bg-success{% elif service.status == 'in_progress' %}bg-primary{% elif service.status == 'cancelled' %}bg-danger{% else %}bg-warning{% endif %}">
                                                    {{ service.get_status_display }}
                                                </span>
                                            </td>
                                            <td>
                                                <a href="{% url 'car_rental:service_booking_detail' service.id %}" class="btn btn-sm btn-outline-primary">View</a>
                                                <a href="{% url 'car_rental:update_service_booking_status' service.id %}" class="btn btn-sm btn-outline-warning">Update Status</a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No service history found for this customer.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #0d6efd;
    }
    
    .stat-label {
        font-size: 14px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Bootstrap tabs
        var triggerTabList = [].slice.call(document.querySelectorAll('#customerTabs button'))
        triggerTabList.forEach(function (triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl)
        });
    });
</script>
{% endblock %}